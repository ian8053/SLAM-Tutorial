# SLAM Course 02 - Homogeneous Coordinates（齊次座標）

> 本筆記整理自 Cyrill Stachniss 的 SLAM 課程第二講

---

## 為什麼需要離開笛卡爾座標系？

### 問題：相機是「只看方向」的感測器

相機這類 **bearing-only sensor**（方位感測器）的特性：
- 只能知道物體的**角度方向**（哪個像素）
- **無法**從單張影像得知物體的**距離**
- 3D 世界被**投影**到 2D 影像平面

### Central Projection（中心投影）模型

```
         3D 物體
            \
             \  所有光線通過投影中心
              \
    ───────────●─────────── 2D 影像平面
              相機
```

這就是你在學校學過的針孔相機模型（Pinhole Camera Model）。

### 笛卡爾座標的問題

在 Euclidean（笛卡爾）幾何中處理投影：
- 數學會變得**複雜**
- 旋轉可以用矩陣，但**平移必須用加法**
- 無法用有限的座標表示**無窮遠點**

**解決方案：使用 Projective Geometry（投影幾何）和 Homogeneous Coordinates（齊次座標）**

---

## Projective Geometry（投影幾何）是什麼？

投影幾何是專門處理「投影」的數學框架：

| Euclidean Geometry | Projective Geometry |
|-------------------|---------------------|
| 點用 (x, y) 表示 | 點用 (x, y, w) 表示 |
| 不能表示無窮遠點 | 可以表示無窮遠點 |
| 平移要用「加法」 | 平移可以用「矩陣乘法」 |
| 變換較複雜 | 所有變換都是矩陣乘法 |

**重點：投影幾何不改變物體和空間的關係，只是讓數學變簡單**

---

## Homogeneous Coordinates（齊次座標）定義

### 核心定義

> **X 和 λ·X 代表同一個物件**（只要 λ ≠ 0）

這是齊次座標最重要的性質！

### 具體例子

```
點 (u, v, w) 和點 (λu, λv, λw) 是同一個點

例如：
(6, 4, 2) = (3, 2, 1) = (12, 8, 4)   ← 這三個都是同一點！

轉換到 Euclidean：除以最後一個座標
(6, 4, 2) → (6/2, 4/2) = (3, 2)
```

### 維度對照

| 空間 | Euclidean | Homogeneous |
|------|-----------|-------------|
| 2D | (x, y) | (x, y, 1) 或 (λx, λy, λ) |
| 3D | (x, y, z) | (x, y, z, 1) 或 (λx, λy, λz, λ) |

**規則：N 維空間用 N+1 維齊次座標表示**

---

## 齊次座標的幾何意義

### 那個「線」的圖在講什麼？

```
           齊次空間 (3D)
              ↗
             /
            /  ← 通過原點的一條線
           /
          /
─────────●──────────── R² 平面 (w = 1)
       (x, y, 1)
        ↑
    Euclidean 點
```

**關鍵理解：**

1. **R² 平面**是齊次空間中 **w = 1** 的那個平面
2. 在齊次空間中，**一整條通過原點的線**代表 R² 上的**一個點**
3. 線上的任何點，投影到 w=1 平面後，都是同一個 Euclidean 點

### 這跟相機有什麼關係？

```
3D 空間中的光線（通過相機中心）
        ↓
  線上的任何 3D 點
        ↓
  都投影到影像的同一個像素！
```

這就是為什麼齊次座標非常適合描述相機投影。

---

## Euclidean ↔ Homogeneous 轉換

### Euclidean → Homogeneous

**直接加一個維度，值為 1**

```
2D: (x, y)     →  (x, y, 1)
3D: (x, y, z)  →  (x, y, z, 1)
```

### Homogeneous → Euclidean

**除以最後一個座標，然後去掉它**

```
2D: (u, v, w)     →  (u/w, v/w)
3D: (u, v, w, t)  →  (u/t, v/t, w/t)
```

### 例子

```
Homogeneous:  (6, 9, 3)
Euclidean:    (6/3, 9/3) = (2, 3)

Homogeneous:  (4, 8, 12, 4)
Euclidean:    (4/4, 8/4, 12/4) = (1, 2, 3)
```

---

## 座標原點和無窮遠點

### 原點的表示

```
Euclidean 原點 (0, 0)
    ↓
Homogeneous: (0, 0, 1) 或 (0, 0, 2) 或 (0, 0, λ)
```

任何 (0, 0, λ) 都代表原點（因為 0/λ = 0）

### 無窮遠點（Points at Infinity）

**這是齊次座標的獨特能力！**

```
無窮遠點：(u, v, 0)   ← 最後一個座標是 0

為什麼？
轉換時要除以 0：(u/0, v/0) → 無窮大！
```

這樣我們可以用**有限的座標**表示**無窮遠的點**。

在相機應用中：你看到一個物體在某個方向，但不知道距離，它可能在無窮遠處。

---

## 為什麼齊次座標讓變換變簡單？

### 笛卡爾座標的問題

```cpp
// 旋轉：可以用矩陣
x' = R * x

// 平移：必須用加法！
x' = x + t

// 旋轉 + 平移：混合操作
x' = R * x + t   ← 不能用單一矩陣表示
```

### 齊次座標的優勢

```cpp
// 旋轉 + 平移：單一矩陣乘法！
x' = M * x

// 連續變換：矩陣連乘
x'' = M2 * M1 * x
```

**所有變換都是矩陣乘法，可以輕鬆串接！**

---

## 變換矩陣的結構

### 3D 變換（4×4 矩陣）

```
M = | R    t  |     R = 3×3 旋轉矩陣
    | 0ᵀ   1  |     t = 3×1 平移向量
                    0ᵀ = (0, 0, 0)
```

展開：
```
    | r₁₁  r₁₂  r₁₃  tx |
M = | r₂₁  r₂₂  r₂₃  ty |
    | r₃₁  r₃₂  r₃₃  tz |
    |  0    0    0    1 |
```

### 2D 變換（3×3 矩陣）

```
    | r₁₁  r₁₂  tx |
M = | r₂₁  r₂₂  ty |
    |  0    0    1 |
```

---

## 各種變換類型

### 純平移（Translation）

```
3D:                           2D:
| 1  0  0  tx |               | 1  0  tx |
| 0  1  0  ty |               | 0  1  ty |
| 0  0  1  tz |               | 0  0   1 |
| 0  0  0   1 |
```

效果：點 (x, y, z) → (x+tx, y+ty, z+tz)

### 純旋轉（Rotation）

**2D 旋轉（繞 Z 軸）：**
```
| cos θ  -sin θ   0 |
| sin θ   cos θ   0 |
|   0       0     1 |
```

**3D 繞 X 軸旋轉：**
```
| 1    0        0     0 |
| 0   cos ω  -sin ω   0 |
| 0   sin ω   cos ω   0 |
| 0    0        0     1 |
```

**3D 繞 Y 軸旋轉：**
```
|  cos φ   0   sin φ   0 |
|    0     1     0     0 |
| -sin φ   0   cos φ   0 |
|    0     0     0     1 |
```

**3D 繞 Z 軸旋轉：**
```
| cos κ  -sin κ   0   0 |
| sin κ   cos κ   0   0 |
|   0       0     1   0 |
|   0       0     0   1 |
```

### 剛體變換（Rigid Body / Motion）

旋轉 + 平移，**最常用於 SLAM！**

```
    | R    t |
M = | 0ᵀ   1 |
```

**參數數量：**
- 2D：3 個（1 旋轉 + 2 平移）
- 3D：6 個（3 旋轉 + 3 平移）

### 相似變換（Similarity）

剛體變換 + 均勻縮放

```
    | sR   t |
M = | 0ᵀ   1 |
```

**參數數量：**
- 2D：4 個（1 旋轉 + 2 平移 + 1 縮放）
- 3D：**7 個**（3 旋轉 + 3 平移 + 1 縮放）

### 仿射變換（Affine）

最一般的線性變換（平行線保持平行）

```
    | A    t |     A = 任意 3×3 可逆矩陣
M = | 0ᵀ   1 |
```

**參數數量：**
- 2D：6 個
- 3D：**12 個**（9 + 3）

---

## 參數數量總結

### 2D 變換（P²）

| 變換類型 | 參數數量 | 矩陣形式 |
|---------|---------|---------|
| 平移 | 2 | I, t |
| 旋轉 | 1 | R, 0 |
| 剛體 | 3 | R, t |
| 相似 | 4 | sR, t |
| 仿射 | 6 | A, t |

### 3D 變換（P³）

| 變換類型 | 參數數量 | 說明 |
|---------|---------|------|
| 平移 | 3 | tx, ty, tz |
| 旋轉 | 3 | 繞 X, Y, Z |
| **剛體** | **6** | **SLAM 最常用** |
| 相似 | 7 | +1 scale |
| 仿射 | 12 | 完全自由 |

---

## 2D 變換圖解（Transformations in P²）

```
原始          平移           旋轉          剛體（旋轉+平移）
  □            □→            ◇             ◇→
              tx,ty          θ            θ,tx,ty

縮放          鏡射           剪切          仿射
  ▢            □|            ▱             ◇
 scale        flip          shear         A矩陣
```

### 鏡射（Reflection）

```
Y 軸鏡射：              X 軸鏡射：
| -1  0  0 |            | 1   0  0 |
|  0  1  0 |            | 0  -1  0 |
|  0  0  1 |            | 0   0  1 |
```

### 剪切（Shear）

```
| 1  k  0 |     k > 0: 向右傾斜
| 0  1  0 |     k < 0: 向左傾斜
| 0  0  1 |
```

---

## 逆變換（Inverse Transformation）

### 重要性質：變換矩陣永遠可逆！

```
正向變換：x' = M · x
逆向變換：x  = M⁻¹ · x'
```

**為什麼永遠可逆？**
- 旋轉矩陣 R 永遠可逆（R⁻¹ = Rᵀ）
- 這種結構 [R, t; 0, 1] 保證可逆

### 逆矩陣的計算

對於剛體變換：
```
M = | R   t |
    | 0ᵀ  1 |

M⁻¹ = | Rᵀ   -Rᵀt |
      | 0ᵀ     1   |
```

---

## 矩陣乘法不可交換！

**重要警告：**

```
M₁ · M₂ ≠ M₂ · M₁
```

**例子：**
- 先旋轉再平移 ≠ 先平移再旋轉
- 先繞 X 軸轉再繞 Y 軸轉 ≠ 先繞 Y 軸轉再繞 X 軸轉

**順序很重要！**

---

## SLAM 中的應用

### 座標轉換鏈

```
感測器座標系
     ↓  M₁（感測器到機器人）
機器人座標系
     ↓  M₂（機器人到世界）
世界座標系

總變換：M_total = M₂ · M₁
點轉換：p_world = M₂ · M₁ · p_sensor
```

### 實際例子

LiDAR 掃描到的點 p_lidar，要轉換到世界座標：

```
p_world = T_world_robot · T_robot_lidar · p_lidar
```

其中：
- T_robot_lidar：LiDAR 在機器人上的安裝位置（固定）
- T_world_robot：機器人在世界中的位姿（隨時變化）

---

## 總結

### 為什麼用齊次座標？

1. **統一表示**：所有變換都是矩陣乘法
2. **容易串接**：多個變換直接矩陣相乘
3. **容易求逆**：逆變換就是逆矩陣
4. **可表示無窮遠點**：對相機投影很有用

### 核心概念

| 概念 | 說明 |
|------|------|
| λ·x = x | 縮放不改變點的位置 |
| 多一維 | 2D 用 3D 向量，3D 用 4D 向量 |
| w = 1 平面 | Euclidean 空間嵌入在這 |
| w = 0 | 無窮遠點 |
| 矩陣乘法 | 所有變換的統一形式 |

### SLAM 中最常用

**6 自由度剛體變換**（3 旋轉 + 3 平移）：

```
    | R    t |
M = | 0ᵀ   1 |
```

這就是你在 SLAM 中會不斷看到的變換矩陣！

---

## 參考資源

- [Wikipedia: Homogeneous Coordinates](https://en.wikipedia.org/wiki/Homogeneous_coordinates)
- Cyrill Stachniss SLAM Course Lecture 02
- Multiple View Geometry in Computer Vision (Hartley & Zisserman)
